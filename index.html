<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Winter AR — Snowman & Pines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }

    #overlay {
      position: fixed;
      inset: 8px auto auto 8px;
      z-index: 9999;
      display: flex;
      gap: 8px;
    }

    #overlay button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
    }
  </style>
</head>

<body>
  <!-- Simple UI that works in AR via DOM Overlay -->
  <div id="overlay">
    <button data-mode="snowman">Snowman</button>
    <button data-mode="pine">Pine</button>
    <button data-mode="both">Both</button>
    <button id="clear">Clear</button>
  </div>

  <a-scene renderer="colorManagement: true; physicallyCorrectLights: true"
    webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #overlay" xr-mode-ui="enabled: true" ar-hit-test>
    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>

    <!-- Desktop preview floor (hidden in AR) -->
    <a-plane width="6" height="6" rotation="-90 0 0" color="#e7eef7" hide-on-enter-ar></a-plane>
    <a-camera position="0 1.6 0"></a-camera>
  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');

    // --- UI state ---
    let mode = 'snowman';
    const modes = document.querySelectorAll('#overlay [data-mode]');
    const clearBtn = document.getElementById('clear');
    ['touchstart', 'click'].forEach(evt => {
      modes.forEach(b => b.addEventListener(evt, e => { e.preventDefault(); mode = b.dataset.mode; }));
      clearBtn.addEventListener(evt, e => {
        e.preventDefault();
        document.querySelectorAll('.spawned').forEach(e => e.remove());
      });
    });

    // (Optional) quick logs to verify hit-test + surface
    scene.addEventListener('ar-hit-test-start', () => console.log('[hit-test] scanning…'));
    scene.addEventListener('ar-hit-test-achieved', () => console.log('[hit-test] surface found'));

    // --- Tap the screen to place (not the buttons) ---
    scene.addEventListener('ar-hit-test-select', (e) => {
      const { position, quaternion } = e.detail; // from ar-hit-test
      if (mode === 'snowman' || mode === 'both') spawnSnowman(position, quaternion);
      if (mode === 'pine' || mode === 'both') {
        const p2 = position.clone(); if (mode === 'both') p2.x += 0.25;
        spawnPine(p2, quaternion);
      }
    });
    // A-Frame will create the proper WebXR anchor to keep it stable. :contentReference[oaicite:1]{index=1}


    // --- Builders ---
    function spawnSnowman(pos, quat) {
      const root = el(); root.setAttribute('shadow', 'cast:true; receive:true');

      const b1 = part('a-sphere', { radius: 0.20, color: '#fff', position: '0 0.20 0' });
      const b2 = part('a-sphere', { radius: 0.14, color: '#fff', position: '0 0.43 0' });
      const b3 = part('a-sphere', { radius: 0.10, color: '#fff', position: '0 0.60 0' });
      const nose = part('a-cone', { radiusBottom: 0.02, radiusTop: 0, height: 0.1, color: '#ff7f00', position: '0 0.60 0.10', rotation: '90 0 0' });
      const brim = part('a-cylinder', { radius: 0.11, height: 0.01, color: '#111', position: '0 0.70 0' });
      const top = part('a-cylinder', { radius: 0.07, height: 0.12, color: '#111', position: '0 0.77 0' });
      const armL = part('a-cylinder', { radius: 0.01, height: 0.25, color: '#6d4c41', position: '-0.18 0.43 0', rotation: '0 0 45' });
      const armR = part('a-cylinder', { radius: 0.01, height: 0.25, color: '#6d4c41', position: '0.18 0.43 0', rotation: '0 0 -45' });
      const eyeL = part('a-sphere', { radius: 0.01, color: '#222', position: '-0.03 0.63 0.09' });
      const eyeR = part('a-sphere', { radius: 0.01, color: '#222', position: '0.03 0.63 0.09' });

      [b1, b2, b3, nose, brim, top, armL, armR, eyeL, eyeR].forEach(c => root.appendChild(c));
      commit(root, pos, quat);
    }

    function spawnPine(pos, quat) {
      const root = el(); root.setAttribute('shadow', 'cast:true; receive:true');

      const trunk = part('a-cylinder', { radius: 0.05, height: 0.20, color: '#8d6e63', position: '0 0.10 0' });
      const c1 = part('a-cone', { radiusBottom: 0.25, radiusTop: 0.02, height: 0.35, color: '#2e7d32', position: '0 0.35 0' });
      const c2 = part('a-cone', { radiusBottom: 0.20, radiusTop: 0.02, height: 0.30, color: '#2e7d32', position: '0 0.55 0' });
      const c3 = part('a-cone', { radiusBottom: 0.15, radiusTop: 0.02, height: 0.25, color: '#2e7d32', position: '0 0.70 0' });

      [trunk, c1, c2, c3].forEach(c => root.appendChild(c));
      commit(root, pos, quat);
    }

    // --- helpers ---
    function el() { const e = document.createElement('a-entity'); e.classList.add('spawned'); return e; }
    function commit(root, pos, quat) {
      scene.appendChild(root);
      root.object3D.position.copy(pos);
      root.object3D.quaternion.copy(quat);
    }
    function part(tag, props) {
      const e = document.createElement(tag);
      for (const [k, v] of Object.entries(props)) e.setAttribute(attrName(k), v);
      return e;
      function attrName(k) { return k.replace(/[A-Z]/g, m => '-' + m.toLowerCase()); }
    }
  </script>
</body>

</html>