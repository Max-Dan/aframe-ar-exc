<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Winter AR â€” Place Snowmen & Pine Trees</title>
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<style>
  html, body { margin:0; height:100%; overflow:hidden; background:#000; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }

  /* HUDs */
  #overlay, #ui {
    position: fixed; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
    z-index: 2147483647;
  }
  #overlay { display:none; } /* only visible during AR */
  .toolbar {
    pointer-events:auto; display:flex; gap:.5rem; align-items:center; justify-content:center; flex-wrap:wrap;
    background:rgba(0,0,0,.55); padding:.6rem; border-radius:14px; margin:.75rem auto 0; width:min(720px,calc(100% - 1.5rem));
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
  }
  .toolbar button {
    appearance:none; border:0; border-radius:999px; padding:.65rem 1rem; font-weight:700; font-size:14px; cursor:pointer;
    background:#e1f0ff; color:#0b3d72; box-shadow:0 2px 10px rgba(0,0,0,.25);
  }
  .toolbar button.clear { background:#ffe6e6; color:#6b1111; }
  .hint {
    pointer-events:auto; color:#fff; text-align:center; font-size:13px; opacity:.9; margin:0 auto .75rem;
    background:rgba(0,0,0,.45); padding:.45rem .8rem; border-radius:12px; width:min(720px,calc(100% - 1.5rem));
  }

  /* A-Frame AR button on top */
  .a-enter-vr-button { right:12px !important; bottom:12px !important; z-index:2147483647 !important; }

  /* Reticle pulse */
  @keyframes pulse { 0%{transform:scale(1);opacity:.9} 50%{transform:scale(1.05);opacity:.6} 100%{transform:scale(1);opacity:.9} }
  #reticle[visible="true"] { animation:pulse 1.2s ease-in-out infinite; }
</style>
</head>
<body>
  <!-- Pre-AR HUD -->
  <div id="ui">
    <div class="toolbar">
      <button id="btnEnter">ðŸš€ Enter AR</button>
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint" id="status">Tap <b>Enter AR</b>. Must be served over <b>HTTPS</b> (or <code>localhost</code>). On iPhone use <b>Safari</b>; on Android use <b>Chrome</b> with Google Play Services for AR.</div>
  </div>

  <!-- In-AR HUD (DOM Overlay) -->
  <div id="overlay">
    <div class="toolbar">
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint">You are in AR. Aim the ring at a flat surface, then place items.</div>
  </div>

  <a-scene
    renderer="alpha:true; physicallyCorrectLights:true; colorManagement:true; antialias:true"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #overlay"
    xr-mode-ui="enabled: true; enterARButton: true; enterVRButton: false"
    vr-mode-ui="enabled: false">

    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 1.2" position="1 3 2"></a-entity>

    <!-- Camera -->
    <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>

    <!-- Reticle -->
    <a-entity id="reticle" visible="false" rotation="-90 0 0"
              geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.07"
              material="shader: flat; color: #ffffff; opacity: 0.95"></a-entity>

    <a-entity id="placements"></a-entity>
  </a-scene>

<script>
  // --- Stable hit-test reticle component ---
  if (!AFRAME.components['winter-hit-test']) {
    AFRAME.registerComponent('winter-hit-test', {
      init() {
        this.source = null; this.viewer = null; this.ref = null;
        this.reticle = document.getElementById('reticle');
        this.onEnter = this.onEnter.bind(this);
        this.onExit = this.onExit.bind(this);
        const scene = this.el.sceneEl;
        scene.addEventListener('enter-vr', this.onEnter);
        scene.addEventListener('exit-vr', this.onExit);
      },
      onEnter() {
        const scene = this.el.sceneEl;
        if (!scene.is('ar-mode')) return;
        const session = scene.renderer.xr.getSession();
        if (!session) return;
        Promise.all([ session.requestReferenceSpace('viewer'),
                      session.requestReferenceSpace('local') ])
        .then(([viewer, ref]) => {
          this.viewer = viewer; this.ref = ref;
          return session.requestHitTestSource({ space: viewer });
        })
        .then(src => { this.source = src; })
        .catch(err => console.warn('HitTest init failed:', err));
      },
      onExit() {
        this.source?.cancel?.();
        this.source = null; this.viewer = null; this.ref = null;
        this.reticle?.setAttribute('visible', false);
      },
      tick() {
        if (!this.source || !this.ref) return;
        const r = this.el.sceneEl.renderer; if (!r?.xr) return;
        const frame = r.xr.getFrame?.(); if (!frame) return;
        const results = frame.getHitTestResults(this.source);
        if (results && results.length) {
          const pose = results[0].getPose(this.ref);
          if (!pose) { this.reticle.setAttribute('visible', false); return; }
          const t = pose.transform;
          const o3d = this.reticle.object3D;
          o3d.position.set(t.position.x, t.position.y, t.position.z);
          o3d.quaternion.set(t.orientation.x, t.orientation.y, t.orientation.z, t.orientation.w);
          this.reticle.setAttribute('visible', true);
        } else {
          this.reticle.setAttribute('visible', false);
        }
      }
    });
  }
  document.querySelector('a-scene').setAttribute('winter-hit-test','');

  // --- Builders ---
  function createSnowman(s=1){
    const root = document.createElement('a-entity'); root.classList.add('snowman');
    const base = document.createElement('a-sphere'); base.setAttribute('radius',0.22*s); base.setAttribute('position',`0 ${0.22*s} 0`); base.setAttribute('color','#fff');
    const mid  = document.createElement('a-sphere'); mid.setAttribute('radius',0.16*s);  mid.setAttribute('position',`0 ${0.42*s} 0`);  mid.setAttribute('color','#fff');
    const head = document.createElement('a-sphere'); head.setAttribute('radius',0.12*s); head.setAttribute('position',`0 ${0.58*s} 0`); head.setAttribute('color','#fff');
    for(let i=0;i<2;i++){ const eye=document.createElement('a-sphere'); eye.setAttribute('radius',0.012*s); eye.setAttribute('position',`${(i?0.035:-0.035)*s} ${0.60*s} ${-0.095*s}`); eye.setAttribute('color','#111'); root.appendChild(eye); }
    const nose=document.createElement('a-cone'); nose.setAttribute('radius-bottom',0.015*s); nose.setAttribute('radius-top',0); nose.setAttribute('height',0.09*s); nose.setAttribute('color','#FF7F2A'); nose.setAttribute('position',`0 ${0.585*s} ${-0.12*s}`); nose.setAttribute('rotation','-90 0 0');
    [0.50,0.46,0.42].forEach(h=>{ const b=document.createElement('a-sphere'); b.setAttribute('radius',0.012*s); b.setAttribute('position',`0 ${h*s} ${-0.14*s}`); b.setAttribute('color','#111'); root.appendChild(b); });
    const l=document.createElement('a-cylinder'); l.setAttribute('radius',0.009*s); l.setAttribute('height',0.28*s); l.setAttribute('color','#7a4a12'); l.setAttribute('position',`${-0.20*s} ${0.44*s} 0`); l.setAttribute('rotation','0 0 30');
    const r=document.createElement('a-cylinder'); r.setAttribute('radius',0.009*s); r.setAttribute('height',0.28*s); r.setAttribute('color','#7a4a12'); r.setAttribute('position',`${ 0.20*s} ${0.44*s} 0`); r.setAttribute('rotation','0 0 -30');
    const brim=document.createElement('a-cylinder'); brim.setAttribute('radius',0.12*s); brim.setAttribute('height',0.02*s); brim.setAttribute('color','#111'); brim.setAttribute('position',`0 ${0.69*s} 0`);
    const crown=document.createElement('a-cylinder'); crown.setAttribute('radius',0.07*s); crown.setAttribute('height',0.12*s); crown.setAttribute('color','#111'); crown.setAttribute('position',`0 ${0.76*s} 0`);
    [base,mid,head,nose,l,r,brim,crown].forEach(e=>root.appendChild(e)); return root;
  }
  function createPine(s=1){
    const root=document.createElement('a-entity'); root.classList.add('pine');
    const trunk=document.createElement('a-cylinder'); trunk.setAttribute('radius',0.05*s); trunk.setAttribute('height',0.30*s); trunk.setAttribute('color','#5b3a1a'); trunk.setAttribute('position',`0 ${0.15*s} 0`);
    [{r:0.26,h:0.30,y:0.40},{r:0.20,h:0.26,y:0.56},{r:0.14,h:0.22,y:0.70}]
      .forEach(t=>{ const cone=document.createElement('a-cone'); cone.setAttribute('radius-bottom',t.r*s); cone.setAttribute('radius-top',0); cone.setAttribute('height',t.h*s); cone.setAttribute('color','#1f7a3a'); cone.setAttribute('position',`0 ${t.y*s} 0`); root.appendChild(cone); });
    const cap=document.createElement('a-sphere'); cap.setAttribute('radius',0.06*s); cap.setAttribute('position',`0 ${0.83*s} 0`); cap.setAttribute('color','#fff');
    root.appendChild(trunk); root.appendChild(cap); return root;
  }

  // --- Placement ---
  const reticle = document.getElementById('reticle');
  const placements = document.getElementById('placements');
  function placeAtReticle(make){
    const v = reticle.getAttribute('visible');
    if (!(v===true || v==='true')) return;
    const pos = new THREE.Vector3(); const quat = new THREE.Quaternion();
    reticle.object3D.getWorldPosition(pos); reticle.object3D.getWorldQuaternion(quat);
    const item = make(); item.object3D.position.copy(pos);
    const euler = new THREE.Euler().setFromQuaternion(quat,'YXZ');
    item.setAttribute('rotation', `0 ${THREE.MathUtils.radToDeg(euler.y)} 0`);
    placements.appendChild(item);
  }
  function clearAll(){ while (placements.firstChild) placements.removeChild(placements.firstChild); }

  // --- Wire buttons (both HUDs) ---
  function wire(root){
    root?.querySelector('[data-action="snowman"]')?.addEventListener('click', ()=>placeAtReticle(()=>createSnowman(1)));
    root?.querySelector('[data-action="tree"]')?.addEventListener('click', ()=>placeAtReticle(()=>createPine(1)));
    root?.querySelector('[data-action="both"]')?.addEventListener('click', ()=>{
      placeAtReticle(()=>{
        const g=document.createElement('a-entity'); const s=createSnowman(1); const t=createPine(1);
        s.setAttribute('position','-0.25 0 0'); t.setAttribute('position','0.25 0 0'); g.appendChild(s); g.appendChild(t); return g;
      });
    });
    root?.querySelector('[data-action="clear"]')?.addEventListener('click', clearAll);
  }
  wire(document.getElementById('ui'));
  wire(document.getElementById('overlay'));

  // --- Enter/Exit AR to swap HUDs ---
  const sceneEl = document.querySelector('a-scene');
  const overlayRoot = document.getElementById('overlay');
  const uiRoot = document.getElementById('ui');
  const statusEl = document.getElementById('status');

  sceneEl.addEventListener('enter-vr', ()=>{
    if (sceneEl.is('ar-mode')) { overlayRoot.style.display='flex'; uiRoot.style.display='none'; }
  });
  sceneEl.addEventListener('exit-vr', ()=>{ overlayRoot.style.display='none'; uiRoot.style.display='flex'; });

  // Make our "Enter AR" button click A-Frameâ€™s own button (more compatible)
  document.getElementById('btnEnter').addEventListener('click', async ()=>{
    if (location.protocol!=='https:' && location.hostname!=='localhost' && location.hostname!=='127.0.0.1') {
      statusEl.textContent = 'This must be served over HTTPS (or localhost).'; return;
    }
    if (!('xr' in navigator)) { statusEl.textContent = 'WebXR not available in this browser.'; return; }
    try {
      const ok = await navigator.xr.isSessionSupported('immersive-ar');
      if (!ok) { statusEl.textContent = 'Immersive AR not supported on this device/browser.'; return; }
    } catch(e){}

    // Prefer clicking the A-Frame AR button (more stable across browsers)
    const afBtn = document.querySelector('.a-enter-vr-button');
    if (afBtn) { afBtn.click(); return; }
    // Fallback
    sceneEl.enterVR();
  });
</script>
</body>
</html>
