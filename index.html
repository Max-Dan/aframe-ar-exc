<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Winter AR â€” Place Snowmen & Pine Trees</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* On-screen UI that also works inside WebXR via dom-overlay */
    #overlay, #ui { 
      position: fixed; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; 
      z-index: 2147483647; /* keep HUD above A-Frame canvas */
    }
    #overlay { display: none; } /* hidden until AR session starts */
    .toolbar {
      pointer-events: auto; display: flex; gap: .5rem; align-items: center; justify-content: center; flex-wrap: wrap;
      background: rgba(0,0,0,.55); padding: .6rem; border-radius: 14px; margin: .75rem auto 0; width: min(720px, calc(100% - 1.5rem));
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .toolbar button {
      appearance: none; border: 0; border-radius: 999px; padding: .65rem 1rem; font-weight: 700; font-size: 14px; cursor: pointer;
      background: #e1f0ff; color: #0b3d72; box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }
    .toolbar button:hover { filter: brightness(1.05); }
    .toolbar button:active { transform: translateY(1px); }

    .toolbar button.clear { background: #ffe6e6; color: #6b1111; }

    .hint {
      pointer-events: auto; color: white; text-align: center; font-size: 13px; opacity: .9; margin: 0 auto .75rem;
      background: rgba(0,0,0,.45); padding: .45rem .8rem; border-radius: 12px; width: min(720px, calc(100% - 1.5rem));
    }

    /* Reticle pulse when tracking */
    @keyframes pulse { 0% { transform: scale(1); opacity: .9;} 50% { transform: scale(1.05); opacity: .6;} 100% { transform: scale(1); opacity: .9;} }
    #reticle[visible="true"] { animation: pulse 1.2s ease-in-out infinite; }

    /* Move default Enter AR button into bottom-right */
    .a-enter-vr-button { right: 12px !important; bottom: 12px !important; z-index: 2147483647 !important; }
  </style>
</head>
<body>
  <!-- Overlay UI that will also show inside AR via WebXR dom-overlay -->
  <div id="ui">
    <div class="toolbar">
      <button id="startAR">ðŸš€ Start AR</button>
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint" id="preHint">Tap <strong>Start AR</strong> then move your device to find a flat surface. Must be served over <strong>HTTPS</strong> (or <code>localhost</code>) on an ARâ€‘capable mobile browser.</div>
  </div>

  <!-- DOM Overlay root only for AR session -->
  <div id="overlay">
    <div class="toolbar">
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint">You are in AR. Aim the ring and use the buttons to place items.</div>
  </div>

  <a-scene
    renderer="physicallyCorrectLights: true; colorManagement: true; antialias: true"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #overlay"
    background="color: #87CEEB">

    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 1.25; castShadow: true" position="1 3 2"></a-entity>

    <!-- Camera -->
    <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>

    <!-- Reticle (ring that sticks to detected planes) -->
    <a-entity id="reticle" visible="false" rotation="-90 0 0"
              geometry="primitive: ring; radiusInner: 0.04; radiusOuter: 0.06"
              material="shader: flat; color: #ffffff; opacity: 0.95"></a-entity>

    <!-- Container for all placed objects -->
    <a-entity id="placements"></a-entity>
  </a-scene>

  <script>
    // ------- WebXR Hit Test -> Reticle component -------
    if (!AFRAME.components['winter-hit-test']) AFRAME.registerComponent('winter-hit-test', {
      init: function () {
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.refSpace = null;
        this.reticle = document.getElementById('reticle');
        this.onSessionStarted = this.onSessionStarted.bind(this);
        this.onSessionEnded = this.onSessionEnded.bind(this);

        const scene = this.el.sceneEl;
        scene.addEventListener('enter-vr', () => {
          if (scene.is('ar-mode')) this.onSessionStarted();
        });
        scene.addEventListener('exit-vr', this.onSessionEnded);
      },
      onSessionStarted: function () {
        const xr = this.el.sceneEl.renderer.xr;
        const session = xr.getSession();
        if (!session) return;
        // Reference spaces
        Promise.all([
          session.requestReferenceSpace('viewer'),
          session.requestReferenceSpace('local')
        ]).then(([viewer, ref]) => {
          this.viewerSpace = viewer;
          this.refSpace = ref;
          return session.requestHitTestSource({ space: viewer });
        }).then((source) => {
          this.xrHitTestSource = source;
        }).catch(() => {});
      },
      onSessionEnded: function () {
        if (this.xrHitTestSource && this.xrHitTestSource.cancel) this.xrHitTestSource.cancel();
        this.xrHitTestSource = null;
        this.viewerSpace = null;
        this.refSpace = null;
        if (this.reticle) this.reticle.setAttribute('visible', false);
      },
      tick: function () {
        if (!this.xrHitTestSource || !this.refSpace) return;
        const xr = this.el.sceneEl.renderer.xr;
        const frame = xr.getFrame && xr.getFrame();
        if (!frame) return;
        const results = frame.getHitTestResults(this.xrHitTestSource);
        if (results && results.length) {
          const pose = results[0].getPose(this.refSpace);
          const pos = pose.transform.position;
          const orient = pose.transform.orientation;
          const o3d = this.reticle.object3D;
          o3d.position.set(pos.x, pos.y, pos.z);
          o3d.quaternion.set(orient.x, orient.y, orient.z, orient.w);
          this.reticle.setAttribute('visible', true);
        } else {
          this.reticle.setAttribute('visible', false);
        }
      }
    });

    // Attach the component to the scene
    document.querySelector('a-scene').setAttribute('winter-hit-test', '');

    // ------- Helpers to build geometry-made snowman & tree -------
    function createSnowman(scale = 1) {
      const root = document.createElement('a-entity');
      root.classList.add('snowman');
      root.setAttribute('shadow', 'cast: true; receive: true');

      // Body spheres
      const base = document.createElement('a-sphere');
      base.setAttribute('radius', 0.22 * scale);
      base.setAttribute('position', `0 ${0.22 * scale} 0`);
      base.setAttribute('color', '#FFFFFF');
      base.setAttribute('shadow', 'cast: true; receive: true');

      const mid = document.createElement('a-sphere');
      mid.setAttribute('radius', 0.16 * scale);
      mid.setAttribute('position', `0 ${0.42 * scale} 0`);
      mid.setAttribute('color', '#FFFFFF');
      mid.setAttribute('shadow', 'cast: true; receive: true');

      const head = document.createElement('a-sphere');
      head.setAttribute('radius', 0.12 * scale);
      head.setAttribute('position', `0 ${0.58 * scale} 0`);
      head.setAttribute('color', '#FFFFFF');
      head.setAttribute('shadow', 'cast: true; receive: true');

      // Eyes
      for (let i = 0; i < 2; i++) {
        const eye = document.createElement('a-sphere');
        eye.setAttribute('radius', 0.012 * scale);
        const x = (i === 0 ? -0.035 : 0.035) * scale;
        eye.setAttribute('position', `${x} ${0.60 * scale} ${-0.095 * scale}`);
        eye.setAttribute('color', '#111111');
        root.appendChild(eye);
      }

      // Carrot nose
      const nose = document.createElement('a-cone');
      nose.setAttribute('radius-bottom', 0.015 * scale);
      nose.setAttribute('radius-top', 0);
      nose.setAttribute('height', 0.09 * scale);
      nose.setAttribute('color', '#FF7F2A');
      nose.setAttribute('position', `0 ${0.585 * scale} ${-0.12 * scale}`);
      nose.setAttribute('rotation', '-90 0 0');

      // Buttons on torso
      [0.50, 0.46, 0.42].forEach((h) => {
        const btn = document.createElement('a-sphere');
        btn.setAttribute('radius', 0.012 * scale);
        btn.setAttribute('position', `0 ${h * scale} ${-0.14 * scale}`);
        btn.setAttribute('color', '#111111');
        root.appendChild(btn);
      });

      // Arms (twigs)
      const leftArm = document.createElement('a-cylinder');
      leftArm.setAttribute('radius', 0.009 * scale);
      leftArm.setAttribute('height', 0.28 * scale);
      leftArm.setAttribute('color', '#7a4a12');
      leftArm.setAttribute('position', `${-0.20 * scale} ${0.44 * scale} 0`);
      leftArm.setAttribute('rotation', `0 0 30`);

      const rightArm = document.createElement('a-cylinder');
      rightArm.setAttribute('radius', 0.009 * scale);
      rightArm.setAttribute('height', 0.28 * scale);
      rightArm.setAttribute('color', '#7a4a12');
      rightArm.setAttribute('position', `${0.20 * scale} ${0.44 * scale} 0`);
      rightArm.setAttribute('rotation', `0 0 -30`);

      // Hat (two cylinders)
      const brim = document.createElement('a-cylinder');
      brim.setAttribute('radius', 0.12 * scale);
      brim.setAttribute('height', 0.02 * scale);
      brim.setAttribute('color', '#111111');
      brim.setAttribute('position', `0 ${0.69 * scale} 0`);

      const crown = document.createElement('a-cylinder');
      crown.setAttribute('radius', 0.07 * scale);
      crown.setAttribute('height', 0.12 * scale);
      crown.setAttribute('color', '#111111');
      crown.setAttribute('position', `0 ${0.76 * scale} 0`);

      [base, mid, head, nose, leftArm, rightArm, brim, crown].forEach(e => root.appendChild(e));
      return root;
    }

    function createPine(scale = 1) {
      const root = document.createElement('a-entity');
      root.classList.add('pine');
      root.setAttribute('shadow', 'cast: true; receive: true');

      // Trunk
      const trunk = document.createElement('a-cylinder');
      trunk.setAttribute('radius', 0.05 * scale);
      trunk.setAttribute('height', 0.30 * scale);
      trunk.setAttribute('color', '#5b3a1a');
      trunk.setAttribute('position', `0 ${0.15 * scale} 0`);

      // Foliage (stacked cones)
      const tiers = [
        { r: 0.26, h: 0.30, y: 0.40 },
        { r: 0.20, h: 0.26, y: 0.56 },
        { r: 0.14, h: 0.22, y: 0.70 }
      ];
      tiers.forEach(t => {
        const cone = document.createElement('a-cone');
        cone.setAttribute('radius-bottom', t.r * scale);
        cone.setAttribute('radius-top', 0);
        cone.setAttribute('height', t.h * scale);
        cone.setAttribute('color', '#1f7a3a');
        cone.setAttribute('position', `0 ${t.y * scale} 0`);
        root.appendChild(cone);
      });

      // Snow cap on top
      const snowcap = document.createElement('a-sphere');
      snowcap.setAttribute('radius', 0.06 * scale);
      snowcap.setAttribute('position', `0 ${0.83 * scale} 0`);
      snowcap.setAttribute('color', '#FFFFFF');

      root.appendChild(trunk);
      root.appendChild(snowcap);
      return root;
    }

    // ------- Placement helpers -------
    const reticle = document.getElementById('reticle');
    const placements = document.getElementById('placements');

    function placeAtReticle(makeEntityFn) {
      if (reticle.getAttribute('visible') !== true && reticle.getAttribute('visible') !== 'true') {
        hint.textContent = 'Move the device to find a horizontal surface (the white ring).';
        hint.style.background = 'rgba(200, 0, 0, .45)';
        setTimeout(() => { hint.style.background = 'rgba(0,0,0,.45)'; }, 1200);
        return;
      }
      const pos = new THREE.Vector3();
      const quat = new THREE.Quaternion();
      reticle.object3D.getWorldPosition(pos);
      reticle.object3D.getWorldQuaternion(quat);

      const item = makeEntityFn();
      item.object3D.position.copy(pos);
      // Align upright (use yaw from reticle only)
      const euler = new THREE.Euler().setFromQuaternion(quat, 'YXZ');
      item.setAttribute('rotation', `0 ${THREE.MathUtils.radToDeg(euler.y)} 0`);

      placements.appendChild(item);
    }

    function clearAll() {
      while (placements.firstChild) placements.removeChild(placements.firstChild);
    }

    // ------- Wire up buttons (both UI and overlay) -------
    function wireToolbar(root){
      if (!root) return;
      const btnSnow = root.querySelector('[data-action="snowman"]');
      const btnTree = root.querySelector('[data-action="tree"]');
      const btnBoth = root.querySelector('[data-action="both"]');
      const btnClear = root.querySelector('[data-action="clear"]');
      if (btnSnow) btnSnow.addEventListener('click', () => { placeAtReticle(() => createSnowman(1)); });
      if (btnTree) btnTree.addEventListener('click', () => { placeAtReticle(() => createPine(1)); });
      if (btnBoth) btnBoth.addEventListener('click', () => {
        placeAtReticle(() => {
          const group = document.createElement('a-entity');
          const snowman = createSnowman(1);
          const tree = createPine(1);
          snowman.setAttribute('position', '-0.25 0 0');
          tree.setAttribute('position', '0.25 0 0');
          group.appendChild(snowman); group.appendChild(tree);
          return group;
        });
      });
      if (btnClear) btnClear.addEventListener('click', () => {
        while (placements.firstChild) placements.removeChild(placements.firstChild);
      });
    }
    wireToolbar(document.getElementById('ui'));

    // Start AR button & support checks
    const startAR = document.getElementById('startAR');
    const preHint = document.getElementById('preHint');
    if (startAR) {
      startAR.addEventListener('click', async () => {
        try { document.querySelector('a-scene').enterVR(); } catch(e) { console.warn(e); }
      });
    }
    (async function supportChecks(){
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        preHint && (preHint.textContent = 'This page must be served over HTTPS (or localhost) for camera access.');
      }
      if (!('xr' in navigator)) {
        preHint && (preHint.textContent = 'WebXR not available in this browser. Use Chrome on Android or iOS 17+ Safari.');
        if (startAR) startAR.disabled = true;
        return;
      }
      try {
        const ok = await navigator.xr.isSessionSupported('immersive-ar');
        if (!ok) {
          preHint && (preHint.textContent = 'Immersive AR not supported on this device/browser.');
          if (startAR) startAR.disabled = true;
        }
      } catch (e) { /* ignore */ }
    })();
    wireToolbar(document.getElementById('overlay'));

    // Toggle which HUD is visible depending on AR mode
    const sceneEl = document.querySelector('a-scene');
    const overlayRoot = document.getElementById('overlay');
    const uiRoot = document.getElementById('ui');
    sceneEl.addEventListener('enter-vr', () => {
      if (sceneEl.is('ar-mode')) { overlayRoot.style.display = 'flex'; uiRoot.style.display = 'none'; }
    });
    sceneEl.addEventListener('exit-vr', () => {
      overlayRoot.style.display = 'none'; uiRoot.style.display = 'flex';
    });

    // Optional: simple snowfall for atmosphere
    ;(function snowfall(){
      const scene = document.querySelector('a-scene');
      const flakes = document.createElement('a-entity');
      flakes.setAttribute('position', '0 3 0');
      for (let i=0;i<60;i++){
        const f = document.createElement('a-sphere');
        const x = (Math.random()*6 - 3).toFixed(2);
        const z = (Math.random()*6 - 3).toFixed(2);
        const r = (Math.random()*0.01 + 0.005).toFixed(3);
        const h = (Math.random()*2 + 1.2).toFixed(2);
        f.setAttribute('radius', r);
        f.setAttribute('color', '#FFFFFF');
        f.setAttribute('position', `${x} ${h} ${z}`);
        f.setAttribute('material', 'shader: flat; opacity: 0.95; transparent: true');
        f.setAttribute('animation__fall', `property: position; to: ${x} -0.2 ${z}; dur: ${(4000+Math.random()*4000).toFixed(0)}; dir: alternate; loop: true; easing: linear`);
        flakes.appendChild(f);
      }
      scene.appendChild(flakes);
    })();
  </script>
</body>
</html>
