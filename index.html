<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Winter AR â€” Place Snowmen & Pine Trees</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }

    /* HUDs (pre-AR and in-AR) */
    #overlay, #ui {
      position: fixed; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
      z-index: 2147483647; /* keep above A-Frame canvas */
    }
    #overlay { display: none; } /* only visible during AR */
    .toolbar {
      pointer-events: auto; display: flex; gap: .5rem; align-items: center; justify-content: center; flex-wrap: wrap;
      background: rgba(0,0,0,.55); padding: .6rem; border-radius: 14px; margin: .75rem auto 0; width: min(720px, calc(100% - 1.5rem));
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .toolbar button {
      appearance: none; border: 0; border-radius: 999px; padding: .65rem 1rem; font-weight: 700; font-size: 14px; cursor: pointer;
      background: #e1f0ff; color: #0b3d72; box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }
    .toolbar button.clear { background: #ffe6e6; color: #6b1111; }
    .hint {
      pointer-events: auto; color: white; text-align: center; font-size: 13px; opacity: .9; margin: 0 auto .75rem;
      background: rgba(0,0,0,.45); padding: .45rem .8rem; border-radius: 12px; width: min(720px, calc(100% - 1.5rem));
    }

    /* Reticle pulse */
    @keyframes pulse { 0% { transform: scale(1); opacity: .9;} 50% { transform: scale(1.05); opacity: .6;} 100% { transform: scale(1); opacity: .9;} }
    #reticle[visible="true"] { animation: pulse 1.2s ease-in-out infinite; }

    /* Default A-Frame AR button placement (keep tappable) */
    .a-enter-vr-button { right: 12px !important; bottom: 12px !important; z-index: 2147483647 !important; }
  </style>
</head>
<body>
  <!-- Pre-AR HUD -->
  <div id="ui">
    <div class="toolbar">
      <button id="startAR">ðŸš€ Start AR</button>
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint" id="preHint">
      Tap <strong>Start AR</strong>. Must be served over <strong>HTTPS</strong> (or <code>localhost</code>) on an AR-capable mobile browser.
    </div>
  </div>

  <!-- In-AR HUD (DOM Overlay) -->
  <div id="overlay">
    <div class="toolbar">
      <button data-action="snowman">â›„ Place Snowman</button>
      <button data-action="tree">ðŸŒ² Place Tree</button>
      <button data-action="both">â›„+ðŸŒ² Both</button>
      <button data-action="clear" class="clear">ðŸ§¹ Clear</button>
    </div>
    <div class="hint">You are in AR. Aim the ring at a flat surface, then place items.</div>
  </div>

  <a-scene
    renderer="alpha: true; physicallyCorrectLights: true; colorManagement: true; antialias: true"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #overlay"
    xr-mode-ui="enabled: true; enterARButton: true; enterVRButton: false">

    <!-- Lights (soft) -->
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 1.2" position="1 3 2"></a-entity>

    <!-- Camera -->
    <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>

    <!-- Reticle that sticks to planes -->
    <a-entity id="reticle" visible="false" rotation="-90 0 0"
              geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.07"
              material="shader: flat; color: #ffffff; opacity: 0.95"></a-entity>

    <!-- Where we drop items -->
    <a-entity id="placements"></a-entity>
  </a-scene>

  <script>
    // --------- Hit test (reticle) ----------
    if (!AFRAME.components['winter-hit-test']) {
      AFRAME.registerComponent('winter-hit-test', {
        init() {
          this.hitTestSource = null;
          this.viewerSpace = null;
          this.refSpace = null;
          this.reticle = document.getElementById('reticle');

          this.onEnter = () => {
            const scene = this.el.sceneEl;
            if (!scene.is('ar-mode')) return;
            const session = scene.renderer.xr.getSession();
            if (!session) return;

            Promise.all([
              session.requestReferenceSpace('viewer'),
              session.requestReferenceSpace('local')
            ])
            .then(([viewer, local]) => {
              this.viewerSpace = viewer;
              this.refSpace = local;
              return session.requestHitTestSource({ space: viewer });
            })
            .then(source => { this.hitTestSource = source; })
            .catch(err => console.warn('HitTest init failed:', err));
          };

          this.onExit = () => {
            if (this.hitTestSource?.cancel) this.hitTestSource.cancel();
            this.hitTestSource = null;
            this.viewerSpace = null;
            this.refSpace = null;
            this.reticle?.setAttribute('visible', false);
          };

          const scene = this.el.sceneEl;
          scene.addEventListener('enter-vr', this.onEnter);
          scene.addEventListener('exit-vr', this.onExit);
        },

        tick() {
          if (!this.hitTestSource || !this.refSpace) return;
          const r = this.el.sceneEl.renderer;
          if (!r || !r.xr) return;
          const frame = r.xr.getFrame && r.xr.getFrame();
          if (!frame) return;

          const results = frame.getHitTestResults(this.hitTestSource);
          if (results && results.length) {
            const pose = results[0].getPose(this.refSpace);
            if (!pose) { this.reticle.setAttribute('visible', false); return; }
            const { position, orientation } = pose.transform;
            const o3d = this.reticle.object3D;
            o3d.position.set(position.x, position.y, position.z);
            o3d.quaternion.set(orientation.x, orientation.y, orientation.z, orientation.w);
            this.reticle.setAttribute('visible', true);
          } else {
            this.reticle.setAttribute('visible', false);
          }
        }
      });
    }
    document.querySelector('a-scene').setAttribute('winter-hit-test', '');

    // --------- Geometry builders ----------
    function createSnowman(scale = 1) {
      const root = document.createElement('a-entity');
      root.classList.add('snowman');
      root.setAttribute('shadow', 'cast: true; receive: true');

      const base = document.createElement('a-sphere');
      base.setAttribute('radius', 0.22 * scale);
      base.setAttribute('position', `0 ${0.22 * scale} 0`);
      base.setAttribute('color', '#FFFFFF');

      const mid = document.createElement('a-sphere');
      mid.setAttribute('radius', 0.16 * scale);
      mid.setAttribute('position', `0 ${0.42 * scale} 0`);
      mid.setAttribute('color', '#FFFFFF');

      const head = document.createElement('a-sphere');
      head.setAttribute('radius', 0.12 * scale);
      head.setAttribute('position', `0 ${0.58 * scale} 0`);
      head.setAttribute('color', '#FFFFFF');

      // eyes
      for (let i = 0; i < 2; i++) {
        const eye = document.createElement('a-sphere');
        eye.setAttribute('radius', 0.012 * scale);
        eye.setAttribute('position', `${(i ? 0.035 : -0.035) * scale} ${0.60 * scale} ${-0.095 * scale}`);
        eye.setAttribute('color', '#111111');
        root.appendChild(eye);
      }

      // nose
      const nose = document.createElement('a-cone');
      nose.setAttribute('radius-bottom', 0.015 * scale);
      nose.setAttribute('radius-top', 0);
      nose.setAttribute('height', 0.09 * scale);
      nose.setAttribute('color', '#FF7F2A');
      nose.setAttribute('position', `0 ${0.585 * scale} ${-0.12 * scale}`);
      nose.setAttribute('rotation', '-90 0 0');

      // buttons
      [0.50, 0.46, 0.42].forEach(h => {
        const b = document.createElement('a-sphere');
        b.setAttribute('radius', 0.012 * scale);
        b.setAttribute('position', `0 ${h * scale} ${-0.14 * scale}`);
        b.setAttribute('color', '#111111');
        root.appendChild(b);
      });

      // arms
      const leftArm = document.createElement('a-cylinder');
      leftArm.setAttribute('radius', 0.009 * scale);
      leftArm.setAttribute('height', 0.28 * scale);
      leftArm.setAttribute('color', '#7a4a12');
      leftArm.setAttribute('position', `${-0.20 * scale} ${0.44 * scale} 0`);
      leftArm.setAttribute('rotation', `0 0 30`);

      const rightArm = document.createElement('a-cylinder');
      rightArm.setAttribute('radius', 0.009 * scale);
      rightArm.setAttribute('height', 0.28 * scale);
      rightArm.setAttribute('color', '#7a4a12');
      rightArm.setAttribute('position', `${0.20 * scale} ${0.44 * scale} 0`);
      rightArm.setAttribute('rotation', `0 0 -30`);

      // hat
      const brim = document.createElement('a-cylinder');
      brim.setAttribute('radius', 0.12 * scale);
      brim.setAttribute('height', 0.02 * scale);
      brim.setAttribute('color', '#111111');
      brim.setAttribute('position', `0 ${0.69 * scale} 0`);

      const crown = document.createElement('a-cylinder');
      crown.setAttribute('radius', 0.07 * scale);
      crown.setAttribute('height', 0.12 * scale);
      crown.setAttribute('color', '#111111');
      crown.setAttribute('position', `0 ${0.76 * scale} 0`);

      [base, mid, head, nose, leftArm, rightArm, brim, crown].forEach(e => root.appendChild(e));
      return root;
    }

    function createPine(scale = 1) {
      const root = document.createElement('a-entity');
      root.classList.add('pine');

      const trunk = document.createElement('a-cylinder');
      trunk.setAttribute('radius', 0.05 * scale);
      trunk.setAttribute('height', 0.30 * scale);
      trunk.setAttribute('color', '#5b3a1a');
      trunk.setAttribute('position', `0 ${0.15 * scale} 0`);

      const tiers = [
        { r: 0.26, h: 0.30, y: 0.40 },
        { r: 0.20, h: 0.26, y: 0.56 },
        { r: 0.14, h: 0.22, y: 0.70 }
      ];
      tiers.forEach(t => {
        const cone = document.createElement('a-cone');
        cone.setAttribute('radius-bottom', t.r * scale);
        cone.setAttribute('radius-top', 0);
        cone.setAttribute('height', t.h * scale);
        cone.setAttribute('color', '#1f7a3a');
        cone.setAttribute('position', `0 ${t.y * scale} 0`);
        root.appendChild(cone);
      });

      const snowcap = document.createElement('a-sphere');
      snowcap.setAttribute('radius', 0.06 * scale);
      snowcap.setAttribute('position', `0 ${0.83 * scale} 0`);
      snowcap.setAttribute('color', '#FFFFFF');

      root.appendChild(trunk);
      root.appendChild(snowcap);
      return root;
    }

    // --------- Placement ----------
    const reticle = document.getElementById('reticle');
    const placements = document.getElementById('placements');

    function placeAtReticle(makeEntityFn) {
      const isVisible = reticle.getAttribute('visible');
      if (!(isVisible === true || isVisible === 'true')) {
        const overlayHint = document.querySelector('#overlay .hint');
        if (overlayHint) {
          overlayHint.textContent = 'Move the device to find a horizontal surface (look for the white ring).';
          overlayHint.style.background = 'rgba(200,0,0,.45)';
          setTimeout(() => { overlayHint.style.background = 'rgba(0,0,0,.45)'; }, 1200);
        }
        return;
      }
      const pos = new THREE.Vector3();
      const quat = new THREE.Quaternion();
      reticle.object3D.getWorldPosition(pos);
      reticle.object3D.getWorldQuaternion(quat);

      const item = makeEntityFn();
      item.object3D.position.copy(pos);

      const euler = new THREE.Euler().setFromQuaternion(quat, 'YXZ');
      item.setAttribute('rotation', `0 ${THREE.MathUtils.radToDeg(euler.y)} 0`);

      placements.appendChild(item);
    }

    function clearAll() {
      while (placements.firstChild) placements.removeChild(placements.firstChild);
    }

    // --------- Wire HUDs ----------
    function wireToolbar(root){
      if (!root) return;
      root.querySelector('[data-action="snowman"]')?.addEventListener('click', () => placeAtReticle(() => createSnowman(1)));
      root.querySelector('[data-action="tree"]')?.addEventListener('click', () => placeAtReticle(() => createPine(1)));
      root.querySelector('[data-action="both"]')?.addEventListener('click', () => {
        placeAtReticle(() => {
          const group = document.createElement('a-entity');
          const snowman = createSnowman(1);
          const tree = createPine(1);
          snowman.setAttribute('position', '-0.25 0 0');
          tree.setAttribute('position', '0.25 0 0');
          group.appendChild(snowman); group.appendChild(tree);
          return group;
        });
      });
      root.querySelector('[data-action="clear"]')?.addEventListener('click', clearAll);
    }

    wireToolbar(document.getElementById('ui'));
    wireToolbar(document.getElementById('overlay'));

    // --------- Start AR / checks ----------
    const startAR = document.getElementById('startAR');
    const preHint = document.getElementById('preHint');

    if (startAR) {
      startAR.addEventListener('click', async () => {
        const insecure = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
        if (insecure) {
          preHint.innerHTML = 'AR requires <b>HTTPS</b> (or <code>localhost</code>). Host this page on HTTPS.';
          return;
        }
        if (!('xr' in navigator)) { preHint.textContent = 'WebXR not available in this browser.'; return; }

        try {
          const ok = await navigator.xr.isSessionSupported('immersive-ar');
          if (!ok) { preHint.textContent = 'Immersive AR not supported. Update/install Google Play Services for AR.'; return; }
        } catch (e) { /* ignore */ }

        try {
          const scene = document.querySelector('a-scene');
          scene.enterVR(); // starts AR mode in A-Frame
          setTimeout(() => {
            if (!scene.is('ar-mode')) {
              preHint.textContent = 'Could not start AR. Allow camera permission and update Google Play Services for AR.';
            }
          }, 1500);
        } catch (e) {
          preHint.textContent = 'Failed to start AR: ' + e.message;
        }
      });
    }

    // --------- Toggle HUDs when AR starts/exits ----------
    const sceneEl = document.querySelector('a-scene');
    const overlayRoot = document.getElementById('overlay');
    const uiRoot = document.getElementById('ui');

    sceneEl.addEventListener('enter-vr', () => {
      if (sceneEl.is('ar-mode')) { overlayRoot.style.display = 'flex'; uiRoot.style.display = 'none'; }
    });
    sceneEl.addEventListener('exit-vr', () => {
      overlayRoot.style.display = 'none'; uiRoot.style.display = 'flex';
    });
  </script>
</body>
</html>
